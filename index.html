<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kids English Karuta</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&display=swap');

        body {
            font-family: 'Fredoka', 'Segoe UI', sans-serif;
            touch-action: manipulation;
        }

        .card {
            transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        .card:active {
            transform: scale(0.95);
        }
        
        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.15); }
            100% { transform: scale(1); }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px) rotate(-5deg); }
            75% { transform: translateX(5px) rotate(5deg); }
        }
        
        .animate-pop { animation: pop 0.4s ease-out; }
        .animate-shake { animation: shake 0.4s ease-in-out; }

        /* „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes count-pop {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-count { animation: count-pop 0.8s forwards; }

        /* „Éù„Ç§„É≥„Éà„Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóÁî® */
        @keyframes float-up {
            0% { transform: translateY(0) scale(0.8); opacity: 0; }
            20% { transform: translateY(-10px) scale(1.2); opacity: 1; }
            100% { transform: translateY(-40px) scale(1); opacity: 0; }
        }
        .point-popup {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ff9f1c;
            font-weight: bold;
            font-size: 2rem;
            text-shadow: 2px 2px 0 #fff;
            pointer-events: none;
            animation: float-up 0.8s ease-out forwards;
            z-index: 50;
        }

        /* NEW RECORD „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes rainbow {
            0% { color: #ff0000; transform: scale(1); }
            20% { color: #ff9a00; transform: scale(1.1); }
            40% { color: #d0de21; transform: scale(1); }
            60% { color: #4fdc4a; transform: scale(1.1); }
            80% { color: #3fdad8; transform: scale(1); }
            100% { color: #2fc9e2; transform: scale(1.1); }
        }
        .new-record-text {
            animation: rainbow 1s infinite;
            font-weight: 900;
        }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    </style>
</head>
<body class="bg-blue-50 text-slate-800 h-screen flex flex-col overflow-hidden">

    <!-- „Éò„ÉÉ„ÉÄ„Éº -->
    <header class="bg-white shadow-sm p-3 flex justify-between items-center z-10">
        <h1 class="text-xl md:text-2xl font-bold text-orange-500 tracking-wide flex items-center gap-2">
            <span>ü¶Å</span> English Karuta
        </h1>
        <div id="game-info" class="hidden flex gap-4 text-lg font-bold items-center">
            <div class="flex items-center gap-1 text-purple-500 mr-2">
                <span>üî•</span>
                <span id="combo" class="text-xl">0</span>
                <span class="text-xs ml-1">Combo</span>
            </div>
            <div class="flex items-center gap-1 text-slate-600">
                <span>‚è±Ô∏è</span>
                <span id="timer" class="w-8 text-center">60</span>
            </div>
            <div class="flex items-center gap-1 text-orange-500">
                <span>‚≠ê</span>
                <span id="score" class="w-12 text-center">0</span>
            </div>
        </div>
    </header>

    <!-- „É°„Ç§„É≥„Ç®„É™„Ç¢ -->
    <main class="flex-1 relative w-full max-w-4xl mx-auto p-4 overflow-y-auto">
        
        <!-- 1. „Çπ„Çø„Éº„ÉàÁîªÈù¢ -->
        <div id="start-screen" class="absolute inset-0 flex flex-col items-center justify-start pt-10 px-4 transition-opacity duration-300">
            <h2 class="text-2xl font-bold mb-6 text-center text-slate-700">Let's Play! <br><span class="text-base font-normal text-slate-500">„Åà„Çâ„Çì„Åß„Çπ„Çø„Éº„ÉàÔºÅ</span></h2>
            <div id="genre-grid" class="grid grid-cols-2 md:grid-cols-3 gap-4 w-full max-w-lg pb-10">
                <!-- JS„Åß„Éú„Çø„É≥ÁîüÊàê -->
            </div>
        </div>

        <!-- 2. „Ç≤„Éº„É†ÁîªÈù¢ -->
        <div id="game-screen" class="hidden flex flex-col h-full relative">
            
            <!-- „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥„Ç™„Éº„Éê„Éº„É¨„Ç§ -->
            <div id="countdown-overlay" class="hidden absolute inset-0 bg-white/90 z-40 flex items-center justify-center rounded-2xl">
                <div id="countdown-text" class="text-9xl font-bold text-orange-500 drop-shadow-lg">3</div>
            </div>

            <!-- „Ç´„Éº„Éâ„Ç∞„É™„ÉÉ„Éâ -->
            <div id="card-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-3 auto-rows-fr flex-1 content-start pb-20">
                <!-- JS„Åß„Ç´„Éº„ÉâÁîüÊàê -->
            </div>

            <!-- Êìç‰Ωú„Éú„Çø„É≥ -->
            <div class="fixed bottom-6 left-1/2 transform -translate-x-1/2 z-20 flex flex-col items-center">
                <div class="flex items-center gap-4">
                    <button id="quit-btn" class="bg-white text-slate-700 hover:text-slate-900 rounded-full w-14 h-14 shadow-lg flex items-center justify-center text-xl transition-transform active:scale-90 border-4 border-white">
                        üè†
                    </button>
                    <button id="replay-btn" class="bg-orange-500 hover:bg-orange-600 text-white rounded-full w-20 h-20 shadow-lg flex items-center justify-center text-4xl transition-transform active:scale-90 animate-bounce-slow border-4 border-white">
                        üîä
                    </button>
                    <button id="retry-btn" class="bg-slate-700 hover:bg-slate-800 text-white rounded-full w-14 h-14 shadow-lg flex items-center justify-center text-2xl transition-transform active:scale-90 border-4 border-white">
                        üîÑ
                    </button>
                </div>
                <div class="flex items-center gap-4 mt-2 text-xs font-bold text-slate-500">
                    <span class="bg-white/80 px-2 py-1 rounded-full shadow-sm backdrop-blur-sm">Home</span>
                    <span class="bg-white/80 px-2 py-1 rounded-full shadow-sm backdrop-blur-sm">Repeat</span>
                    <span class="bg-white/80 px-2 py-1 rounded-full shadow-sm backdrop-blur-sm">Retry</span>
                </div>
            </div>
        </div>

        <!-- 3. ÁµêÊûúÁîªÈù¢ -->
        <div id="result-screen" class="hidden absolute inset-0 bg-white/95 backdrop-blur-sm z-30 flex flex-col items-center justify-center p-6 animate-fade-in">
            <div class="text-6xl mb-4">üéâ</div>
            <h2 class="text-3xl font-bold text-orange-500 mb-2">Time's Up!</h2>
            
            <!-- NEW RECORDË°®Á§∫Áî® -->
            <div id="new-record-msg" class="hidden text-3xl mb-4 new-record-text">üèÜ NEW RECORD! üèÜ</div>
            
            <p class="text-slate-500 mb-6">„Åä„Å§„Åã„Çå„Åï„ÅæÔºÅ</p>
            <div class="bg-blue-50 rounded-2xl p-8 mb-8 text-center shadow-inner w-full max-w-xs">
                <div class="text-sm text-slate-500 uppercase tracking-wider font-bold mb-1">Score</div>
                <div class="text-6xl font-bold text-slate-800" id="final-score">0</div>
                <div class="text-sm text-slate-400 mt-2">points</div>
            </div>
            <button onclick="showStartScreen()" class="bg-orange-500 hover:bg-orange-600 text-white text-xl font-bold py-4 px-10 rounded-2xl shadow-lg transform transition active:scale-95 flex items-center gap-2">
                <span>üîÑ</span> Play Again
            </button>
        </div>
    </main>

<script>
    // --- „Éá„Éº„Çø„Çª„ÉÉ„Éà ---
    const genres = {
        // --- Êñ∞Ë¶èËøΩÂä†: ÊÑüÊÉÖ ---
        feelings: { label: "Feelings", sub:"„Åç„ÇÇ„Å°", icon: "üòÑ", data: [
            {w:"happy", i:"üòÑ"}, {w:"sad", i:"üò¢"}, {w:"angry", i:"üò†"}, {w:"sleepy", i:"üò™"}, {w:"scared", i:"üò±"},
            {w:"surprised", i:"üò≤"}, {w:"hot", i:"ü•µ"}, {w:"cold", i:"ü•∂"}, {w:"sick", i:"üò∑"}, {w:"tired", i:"üò´"},
            {w:"cool", i:"üòé"}, {w:"love", i:"üòç"}, {w:"funny", i:"üòÜ"}, {w:"cry", i:"üò≠"}, {w:"wink", i:"üòâ"}
        ]},
        // --- Êñ∞Ë¶èËøΩÂä†: Ë∫´„ÅÆÂõû„Çä„ÅÆ„ÇÇ„ÅÆ ---
        daily: { label: "Daily", sub:"„Åø„Åò„Åã„Å™„ÇÇ„ÅÆ", icon: "üëú", data: [
            {w:"umbrella", i:"‚òî"}, {w:"wallet", i:"üëõ"}, {w:"backpack", i:"üéí"}, {w:"gift", i:"üéÅ"}, {w:"balloon", i:"üéà"},
            {w:"doll", i:"üß∏"}, {w:"robot", i:"ü§ñ"}, {w:"game", i:"üéÆ"}, {w:"headphones", i:"üéß"}, {w:"calendar", i:"üìÖ"},
            {w:"trash", i:"üóëÔ∏è"}, {w:"broom", i:"üßπ"}, {w:"bucket", i:"ü™£"}, {w:"medicine", i:"üíä"}, {w:"bandage", i:"ü©π"}
        ]},
        uppercase: { label: "Uppercase", sub:"Â§ßÊñáÂ≠ó", icon: "üÖ∞Ô∏è", data: [
            {w:"A", i:"A"}, {w:"B", i:"B"}, {w:"C", i:"C"}, {w:"D", i:"D"}, {w:"E", i:"E"},
            {w:"F", i:"F"}, {w:"G", i:"G"}, {w:"H", i:"H"}, {w:"I", i:"I"}, {w:"J", i:"J"},
            {w:"K", i:"K"}, {w:"L", i:"L"}, {w:"M", i:"M"}, {w:"N", i:"N"}, {w:"O", i:"O"},
            {w:"P", i:"P"}, {w:"Q", i:"Q"}, {w:"R", i:"R"}, {w:"S", i:"S"}, {w:"T", i:"T"},
            {w:"U", i:"U"}, {w:"V", i:"V"}, {w:"W", i:"W"}, {w:"X", i:"X"}, {w:"Y", i:"Y"},
            {w:"Z", i:"Z"}
        ]},
        lowercase: { label: "Lowercase", sub:"Â∞èÊñáÂ≠ó", icon: "üî°", data: [
            {w:"a", i:"a"}, {w:"b", i:"b"}, {w:"c", i:"c"}, {w:"d", i:"d"}, {w:"e", i:"e"},
            {w:"f", i:"f"}, {w:"g", i:"g"}, {w:"h", i:"h"}, {w:"i", i:"i"}, {w:"j", i:"j"},
            {w:"k", i:"k"}, {w:"l", i:"l"}, {w:"m", i:"m"}, {w:"n", i:"n"}, {w:"o", i:"o"},
            {w:"p", i:"p"}, {w:"q", i:"q"}, {w:"r", i:"r"}, {w:"s", i:"s"}, {w:"t", i:"t"},
            {w:"u", i:"u"}, {w:"v", i:"v"}, {w:"w", i:"w"}, {w:"x", i:"x"}, {w:"y", i:"y"},
            {w:"z", i:"z"}
        ]},
        numbers: { label: "Numbers", sub:"„Åã„Åö", icon: "üî¢", data: [
            {w:"one", i:"1Ô∏è‚É£"}, {w:"two", i:"2Ô∏è‚É£"}, {w:"three", i:"3Ô∏è‚É£"}, {w:"four", i:"4Ô∏è‚É£"}, {w:"five", i:"5Ô∏è‚É£"},
            {w:"six", i:"6Ô∏è‚É£"}, {w:"seven", i:"7Ô∏è‚É£"}, {w:"eight", i:"8Ô∏è‚É£"}, {w:"nine", i:"9Ô∏è‚É£"}, {w:"ten", i:"üîü"},
            {w:"eleven", i:"11"}, {w:"twelve", i:"12"}, {w:"zero", i:"0Ô∏è‚É£"}, {w:"twenty", i:"20"}, {w:"one hundred", i:"üíØ"}
        ]},
        fruits: { label: "Fruits", sub:"„Åè„Å†„ÇÇ„ÅÆ", icon: "üçé", data: [
            {w:"apple", i:"üçé"}, {w:"banana", i:"üçå"}, {w:"grape", i:"üçá"}, {w:"melon", i:"üçà"}, {w:"watermelon", i:"üçâ"},
            {w:"orange", i:"üçä"}, {w:"lemon", i:"üçã"}, {w:"peach", i:"üçë"}, {w:"cherry", i:"üçí"}, {w:"strawberry", i:"üçì"},
            {w:"pineapple", i:"üçç"}, {w:"kiwi", i:"ü•ù"}, {w:"coconut", i:"ü••"}, {w:"pear", i:"üçê"}, {w:"mango", i:"ü•≠"}
        ]},
        animals: { label: "Animals", sub:"„Å©„ÅÜ„Å∂„Å§", icon: "üê∂", data: [
            {w:"dog", i:"üê∂"}, {w:"cat", i:"üê±"}, {w:"mouse", i:"üê≠"}, {w:"rabbit", i:"üê∞"}, {w:"bear", i:"üêª"},
            {w:"panda", i:"üêº"}, {w:"tiger", i:"üêØ"}, {w:"lion", i:"ü¶Å"}, {w:"cow", i:"üêÆ"}, {w:"pig", i:"üê∑"},
            {w:"monkey", i:"üêµ"}, {w:"chicken", i:"üêî"}, {w:"penguin", i:"üêß"}, {w:"frog", i:"üê∏"}, {w:"horse", i:"üê¥"}
        ]},
        food: { label: "Food", sub:"„Åü„Åπ„ÇÇ„ÅÆ", icon: "üçî", data: [
            {w:"burger", i:"üçî"}, {w:"pizza", i:"üçï"}, {w:"hot dog", i:"üå≠"}, {w:"fries", i:"üçü"}, {w:"sandwich", i:"ü•™"},
            {w:"sushi", i:"üç£"}, {w:"rice", i:"üçö"}, {w:"bread", i:"üçû"}, {w:"egg", i:"üç≥"}, {w:"ice cream", i:"üç¶"},
            {w:"cake", i:"üç∞"}, {w:"chocolate", i:"üç´"}, {w:"cookie", i:"üç™"}, {w:"donut", i:"üç©"}, {w:"popcorn", i:"üçø"}
        ]},
        colors: { label: "Nature", sub:"„Åó„Åú„Çì", icon: "üå≥", data: [
            {w:"sun", i:"‚òÄÔ∏è"}, {w:"moon", i:"üåô"}, {w:"star", i:"‚≠ê"}, {w:"cloud", i:"‚òÅÔ∏è"}, {w:"rain", i:"‚òî"},
            {w:"snow", i:"‚õÑ"}, {w:"fire", i:"üî•"}, {w:"water", i:"üíß"}, {w:"flower", i:"üå∫"}, {w:"tree", i:"üå≥"},
            {w:"mountain", i:"‚õ∞Ô∏è"}, {w:"ocean", i:"üåä"}, {w:"rainbow", i:"üåà"}, {w:"Earth", i:"üåé"}, {w:"leaf", i:"üçÉ"}
        ]},
        vehicle: { label: "Vehicles", sub:"„ÅÆ„Çä„ÇÇ„ÅÆ", icon: "üöó", data: [
            {w:"car", i:"üöó"}, {w:"bus", i:"üöå"}, {w:"train", i:"üöÉ"}, {w:"bike", i:"üö≤"}, {w:"plane", i:"‚úàÔ∏è"},
            {w:"ship", i:"üö¢"}, {w:"rocket", i:"üöÄ"}, {w:"taxi", i:"üöï"}, {w:"police car", i:"üöì"}, {w:"ambulance", i:"üöë"},
            {w:"fire engine", i:"üöí"}, {w:"truck", i:"üöö"}, {w:"helicopter", i:"üöÅ"}, {w:"boat", i:"üõ∂"}, {w:"scooter", i:"üõ¥"}
        ]},
        sports: { label: "Sports", sub:"„Çπ„Éù„Éº„ÉÑ", icon: "‚öΩ", data: [
            {w:"soccer", i:"‚öΩ"}, {w:"baseball", i:"‚öæ"}, {w:"basketball", i:"üèÄ"}, {w:"tennis", i:"üéæ"}, {w:"volleyball", i:"üèê"},
            {w:"golf", i:"‚õ≥"}, {w:"running", i:"üèÉ"}, {w:"swimming", i:"üèä"}, {w:"skiing", i:"‚õ∑Ô∏è"}, {w:"boxing", i:"ü•ä"},
            {w:"cycling", i:"üö¥"}, {w:"surfing", i:"üèÑ"}, {w:"skating", i:"‚õ∏Ô∏è"}, {w:"ping pong", i:"üèì"}, {w:"rugby", i:"üèâ"}
        ]},
        body: { label: "Body", sub:"„Åã„Çâ„Å†", icon: "üëÇ", data: [
            {w:"head", i:"üë±"}, {w:"eye", i:"üëÅÔ∏è"}, {w:"ear", i:"üëÇ"}, {w:"nose", i:"üëÉ"}, {w:"mouth", i:"üëÑ"},
            {w:"hand", i:"‚úã"}, {w:"foot", i:"ü¶∂"}, {w:"arm", i:"üí™"}, {w:"leg", i:"ü¶µ"}, {w:"tooth", i:"ü¶∑"},
            {w:"hair", i:"üíá"}, {w:"finger", i:"üëÜ"}, {w:"heart", i:"‚ù§Ô∏è"}, {w:"brain", i:"üß†"}, {w:"bone", i:"ü¶¥"}
        ]},
        school: { label: "School", sub:"„Åå„Å£„Åì„ÅÜ", icon: "üéí", data: [
            {w:"school", i:"üè´"}, {w:"pencil", i:"‚úèÔ∏è"}, {w:"book", i:"üìñ"}, {w:"notebook", i:"üìì"}, {w:"ruler", i:"üìè"},
            {w:"scissors", i:"‚úÇÔ∏è"}, {w:"bag", i:"üéí"}, {w:"desk", i:"ü™ë"}, {w:"computer", i:"üíª"}, {w:"clock", i:"‚è∞"},
            {w:"crayon", i:"üñçÔ∏è"}, {w:"paper", i:"üìÑ"}, {w:"globe", i:"üåç"}, {w:"teacher", i:"üë©‚Äçüè´"}, {w:"music", i:"üéµ"}
        ]},
        clothes: { label: "Clothes", sub:"„Çà„ÅÜ„Åµ„Åè", icon: "üëï", data: [
            {w:"shirt", i:"üëï"}, {w:"pants", i:"üëñ"}, {w:"dress", i:"üëó"}, {w:"hat", i:"üß¢"}, {w:"shoes", i:"üëü"},
            {w:"socks", i:"üß¶"}, {w:"glasses", i:"üëì"}, {w:"coat", i:"üß•"}, {w:"tie", i:"üëî"}, {w:"bikini", i:"üëô"},
            {w:"kimono", i:"üëò"}, {w:"ring", i:"üíç"}, {w:"watch", i:"‚åö"}, {w:"mask", i:"üò∑"}, {w:"glove", i:"üß§"}
        ]},
        jobs: { label: "Jobs", sub:"„Åä„Åó„Åî„Å®", icon: "üë®‚Äç‚öïÔ∏è", data: [
            {w:"doctor", i:"üë®‚Äç‚öïÔ∏è"}, {w:"police", i:"üëÆ"}, {w:"firefighter", i:"üßë‚Äçüöí"}, {w:"cook", i:"üë®‚Äçüç≥"}, {w:"artist", i:"üßë‚Äçüé®"},
            {w:"singer", i:"üßë‚Äçüé§"}, {w:"pilot", i:"üßë‚Äç‚úàÔ∏è"}, {w:"astronaut", i:"üßë‚ÄçüöÄ"}, {w:"farmer", i:"üë©‚Äçüåæ"}, {w:"detective", i:"üïµÔ∏è"},
            {w:"student", i:"üßë‚Äçüéì"}, {w:"king", i:"ü§¥"}, {w:"queen", i:"üë∏"}, {w:"ninja", i:"ü•∑"}, {w:"alien", i:"üëΩ"}
        ]},
        house: { label: "House", sub:"„Åä„ÅÜ„Å°", icon: "üè†", data: [
            {w:"house", i:"üè†"}, {w:"door", i:"üö™"}, {w:"window", i:"ü™ü"}, {w:"bed", i:"üõå"}, {w:"bath", i:"üõÅ"},
            {w:"toilet", i:"üöΩ"}, {w:"soap", i:"üßº"}, {w:"toothbrush", i:"ü™•"}, {w:"key", i:"üîë"}, {w:"camera", i:"üì∑"},
            {w:"phone", i:"üì±"}, {w:"letter", i:"‚úâÔ∏è"}, {w:"box", i:"üì¶"}, {w:"money", i:"üí∞"}, {w:"light", i:"üí°"}
        ]}
    };

    // --- Â§âÊï∞ ---
    let gameState = {
        score: 0,
        timeLeft: 60,
        isPlaying: false,
        genreKey: null,
        deck: [],
        board: [],
        target: null,
        timerId: null,
        countdownId: null,
        combo: 0,
        questionStartTime: 0
    };

    // --- „Éè„Ç§„Çπ„Ç≥„Ç¢ÁÆ°ÁêÜ ---
    let highScores = {};
    const STORAGE_KEY = 'karuta_highscores';

    const synth = window.speechSynthesis;
    let voices = [];

    function initVoices() {
        voices = synth.getVoices();
    }
    if (speechSynthesis.onvoiceschanged !== undefined) {
        speechSynthesis.onvoiceschanged = initVoices;
    }
    initVoices();

    // --- ÂàùÊúüÂåñ ---
    function init() {
        // „Éè„Ç§„Çπ„Ç≥„Ç¢Ë™≠„ÅøËæº„Åø
        const stored = localStorage.getItem(STORAGE_KEY);
        if (stored) {
            highScores = JSON.parse(stored);
        }

        const grid = document.getElementById('genre-grid');
        grid.innerHTML = "";
        
        Object.keys(genres).forEach(key => {
            const g = genres[key];
            const bestScore = highScores[key] || 0;

            const btn = document.createElement('button');
            btn.className = "bg-white border-2 border-blue-100 hover:border-orange-400 rounded-2xl p-4 shadow-sm hover:shadow-md transition flex flex-col items-center gap-1 group relative";
            btn.onclick = () => startGame(key);
            btn.innerHTML = `
                <span class="text-4xl group-hover:scale-110 transition-transform duration-200 mb-1">${g.icon}</span>
                <div class="text-center w-full">
                    <div class="font-bold text-slate-700 leading-tight">${g.label}</div>
                    <div class="text-xs text-slate-400 font-bold mb-1">${g.sub}</div>
                    <div class="bg-orange-100 text-orange-600 text-xs font-bold px-2 py-1 rounded-full inline-block">
                        üèÜ ${bestScore}
                    </div>
                </div>
            `;
            grid.appendChild(btn);
        });
    }

    // --- „Ç≤„Éº„É†ÈñãÂßã ---
    function startGame(key) {
        gameState.genreKey = key;
        gameState.score = 0;
        gameState.timeLeft = 60;
        gameState.combo = 0;
        gameState.isPlaying = false;
        
        // „Éá„Éº„ÇøÊ∫ñÂÇô
        const originalData = JSON.parse(JSON.stringify(genres[key].data));
        gameState.deck = shuffle([...originalData]);
        if (gameState.deck.length < 10) {
            gameState.deck = [...gameState.deck, ...JSON.parse(JSON.stringify(originalData))];
        }

        gameState.board = [];
        for (let i=0; i<10; i++) {
            if (gameState.deck.length > 0) {
                gameState.board.push(gameState.deck.pop());
            }
        }

        // ÁîªÈù¢Âàá„ÇäÊõø„Åà
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('result-screen').classList.add('hidden');
        document.getElementById('game-screen').classList.remove('hidden');
        document.getElementById('game-info').classList.remove('hidden');
        document.getElementById('score').innerText = 0;
        document.getElementById('combo').innerText = 0;
        document.getElementById('timer').innerText = 60;

        renderBoard();
        
        startCountdown();
    }

    function startCountdown() {
        const overlay = document.getElementById('countdown-overlay');
        const countText = document.getElementById('countdown-text');
        overlay.classList.remove('hidden');

        if (gameState.countdownId) {
            clearInterval(gameState.countdownId);
            gameState.countdownId = null;
        }
        
        let count = 3;
        
        const triggerAnim = (text) => {
            countText.innerText = text;
            countText.classList.remove('animate-count');
            void countText.offsetWidth; // „É™„Éï„É≠„Éº
            countText.classList.add('animate-count');
            
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'en-US';
            u.rate = 1.5;
            synth.speak(u);
        };

        triggerAnim(count);

        const interval = setInterval(() => {
            count--;
            if (count > 0) {
                triggerAnim(count);
            } else if (count === 0) {
                triggerAnim("GO!");
            } else {
                clearInterval(interval);
                gameState.countdownId = null;
                overlay.classList.add('hidden');
                gameState.isPlaying = true;
                setNewTarget(); 
                startTimer();
            }
        }, 1000);
        gameState.countdownId = interval;
    }

    function renderBoard() {
        const grid = document.getElementById('card-grid');
        grid.innerHTML = "";

        gameState.board.forEach((card, index) => {
            const el = document.createElement('div');
            el.className = `card relative bg-white border-4 border-slate-100 rounded-2xl flex flex-col items-center justify-center p-2 cursor-pointer h-32 md:h-40 shadow-sm hover:shadow-md hover:border-blue-300`;
            
            if (card) {
                el.innerHTML = `
                    <div class="text-4xl md:text-5xl mb-2">${card.i}</div>
                    <div class="text-sm md:text-lg font-bold text-slate-700 leading-none text-center">${card.w}</div>
                `;
                el.onclick = () => handleCardClick(index);
            } else {
                el.classList.add('invisible');
            }
            grid.appendChild(el);
        });
    }

    function setNewTarget() {
        if (!gameState.isPlaying) return;
        const candidates = gameState.board.filter(c => c !== null);
        if (candidates.length === 0) return;

        gameState.target = candidates[Math.floor(Math.random() * candidates.length)];
        gameState.questionStartTime = Date.now();
        
        setTimeout(() => {
            speak(gameState.target.w);
        }, 300);
    }

    function speak(text) {
        synth.cancel();
        const spokenText = /^[A-Z]$/.test(text) ? text.toLowerCase() : text;
        const u = new SpeechSynthesisUtterance(spokenText);
        u.lang = 'en-US';
        u.rate = 0.9;
        const enVoice = voices.find(v => v.lang.startsWith('en'));
        if (enVoice) u.voice = enVoice;
        synth.speak(u);
    }

    document.getElementById('replay-btn').onclick = () => {
        if (gameState.isPlaying && gameState.target) {
            const btn = document.getElementById('replay-btn');
            btn.classList.remove('animate-bounce-slow');
            void btn.offsetWidth;
            btn.classList.add('animate-bounce-slow');
            speak(gameState.target.w);
        }
    };

    document.getElementById('quit-btn').onclick = () => {
        synth.cancel();
        showStartScreen();
    };

    document.getElementById('retry-btn').onclick = () => {
        if (!gameState.genreKey) return;
        gameState.isPlaying = false;
        if (gameState.timerId) clearInterval(gameState.timerId);
        if (gameState.countdownId) {
            clearInterval(gameState.countdownId);
            gameState.countdownId = null;
        }
        synth.cancel();
        startGame(gameState.genreKey);
    };

    function handleCardClick(index) {
        if (!gameState.isPlaying) return;
        
        const card = gameState.board[index];
        const cardEls = document.getElementById('card-grid').children;
        const el = cardEls[index];

        if (card.w === gameState.target.w) {
            // --- Ê≠£Ëß£Âá¶ÁêÜ ---
            gameState.isPlaying = false;
            
            // ‚ë† ÊôÇÈñìË®àÁÆó
            const now = Date.now();
            const elapsedSec = (now - gameState.questionStartTime) / 1000;
            let baseScore = 100;

            if (elapsedSec > 0.5) {
                const penaltySteps = Math.ceil((elapsedSec - 0.5) / 0.5);
                baseScore = Math.max(10, 100 - (penaltySteps * 5));
            }

            // ‚ë° „Ç≥„É≥„ÉúË®àÁÆó
            gameState.combo++;
            let multiplier = 1.0;
            if (gameState.combo >= 4 && gameState.combo <= 5) multiplier = 1.1;
            else if (gameState.combo >= 6 && gameState.combo <= 10) multiplier = 1.2;
            else if (gameState.combo >= 11) multiplier = 1.3;

            const points = Math.round(baseScore * multiplier);
            gameState.score += points;

            document.getElementById('score').innerText = gameState.score;
            document.getElementById('combo').innerText = gameState.combo;

            el.classList.remove('border-slate-100', 'hover:border-blue-300');
            el.classList.add('bg-green-100', 'border-green-400', 'animate-pop');

            showPointsPopup(el, points, multiplier);
            
            setTimeout(() => {
                replaceCard(index);
                renderBoard();
                gameState.isPlaying = true;
                setNewTarget();
            }, 600);
            
        } else {
            // --- ‰∏çÊ≠£Ëß£Âá¶ÁêÜ ---
            el.classList.add('bg-red-50', 'border-red-400', 'animate-shake');
            speak("Oh no.");
            
            gameState.combo = 0;
            document.getElementById('combo').innerText = 0;

            setTimeout(() => {
                el.classList.remove('bg-red-50', 'border-red-400', 'animate-shake');
            }, 500);
        }
    }

    function showPointsPopup(element, points, multiplier) {
        const rect = element.getBoundingClientRect();
        const popup = document.createElement('div');
        popup.className = 'point-popup';
        
        let text = `+${points}`;
        if (multiplier > 1.0) {
            text += `<div style="font-size:0.6em; color:#ffcc00;">Combo x${multiplier}</div>`;
        }
        popup.innerHTML = text;

        document.body.appendChild(popup);
        
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;
        popup.style.left = `${centerX}px`;
        popup.style.top = `${centerY}px`;

        setTimeout(() => {
            popup.remove();
        }, 800);
    }

    function replaceCard(index) {
        if (gameState.deck.length === 0) {
            refillDeck();
        }
        
        let newCard = null;
        let retry = 0;
        
        while (retry < 10) {
            if (gameState.deck.length === 0) refillDeck();
            const candidate = gameState.deck.pop();
            const isDuplicate = gameState.board.some(c => c && c.w === candidate.w);
            
            if (!isDuplicate) {
                newCard = candidate;
                break;
            } else {
                gameState.deck.unshift(candidate);
            }
            retry++;
        }
        
        if (!newCard) {
             if (gameState.deck.length > 0) newCard = gameState.deck.pop();
             else refillDeck();
        }
        gameState.board[index] = newCard;
    }

    function refillDeck() {
        const original = genres[gameState.genreKey].data;
        const newDeck = JSON.parse(JSON.stringify(original));
        gameState.deck = shuffle(newDeck);
    }

    function startTimer() {
        if (gameState.timerId) clearInterval(gameState.timerId);
        gameState.timerId = setInterval(() => {
            gameState.timeLeft--;
            document.getElementById('timer').innerText = gameState.timeLeft;
            
            if (gameState.timeLeft <= 0) {
                endGame();
            }
        }, 1000);
    }

    function endGame() {
        clearInterval(gameState.timerId);
        gameState.isPlaying = false;
        synth.cancel();
        
        document.getElementById('final-score').innerText = gameState.score;
        document.getElementById('result-screen').classList.remove('hidden');

        // „Éè„Ç§„Çπ„Ç≥„Ç¢Âà§ÂÆö„Å®‰øùÂ≠ò
        const currentBest = highScores[gameState.genreKey] || 0;
        const isNewRecord = gameState.score > currentBest;
        const msgEl = document.getElementById('new-record-msg');

        if (isNewRecord) {
            highScores[gameState.genreKey] = gameState.score;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(highScores));
            msgEl.classList.remove('hidden');
            speak("New Record! Congratulations!");
        } else {
            msgEl.classList.add('hidden');
            speak("Finish! Good job!");
        }
    }

    function showStartScreen() {
        // „Éú„Çø„É≥„ÅÆ„Çπ„Ç≥„Ç¢Ë°®Á§∫„ÇíÊõ¥Êñ∞„Åô„Çã„Åü„ÇÅ„Å´ÂÜçÂàùÊúüÂåñ
        init();

        if (gameState.timerId) clearInterval(gameState.timerId);
        if (gameState.countdownId) {
            clearInterval(gameState.countdownId);
            gameState.countdownId = null;
        }
        synth.cancel();
        
        document.getElementById('result-screen').classList.add('hidden');
        document.getElementById('game-screen').classList.add('hidden');
        document.getElementById('game-info').classList.add('hidden');
        document.getElementById('start-screen').classList.remove('hidden');
    }

    function shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    init();
</script>
</body>
</html>
